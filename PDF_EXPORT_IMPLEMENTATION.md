# PDF Export Feature Implementation

## Overview

This document describes the PDF export feature implementation for ESG Report Studio, allowing users to export generated ESG reports to professional PDF documents.

## Features

### PDF Content

The exported PDF includes:

1. **Title Page**
   - Organization name
   - Report period name and date range
   - Reporting mode (simplified/extended)
   - Report scope (single-company/group)
   - Generated by user and timestamp
   - Total number of sections
   - Optional variant name

2. **Table of Contents**
   - Lists all sections with their order numbers
   - Section titles

3. **Report Sections**
   - Section title, description, and metadata
   - Data points table with alternating row colors
   - Assumptions highlighted in orange
   - Data gaps highlighted in red

4. **Page Numbering**
   - Footer displays "Page X / Total" on every page

## API Endpoint

### Export Report to PDF

**Endpoint:** `POST /api/periods/{periodId}/export-pdf`

**Request Body:**
```json
{
  "generatedBy": "user-id",
  "sectionIds": ["section-1", "section-2"],  // Optional
  "variantName": "Management",  // Optional
  "includeTitlePage": true,  // Default: true
  "includeTableOfContents": true,  // Default: true
  "includePageNumbers": true  // Default: true
}
```

**Response:**
- Content-Type: `application/pdf`
- Content-Disposition: `attachment; filename={Company}_{Period}_{Variant}_{Date}.pdf`
- Binary PDF data

**Error Responses:**
- 400 Bad Request: Missing required fields or invalid period
- 404 Not Found: Period not found
- 500 Internal Server Error: PDF generation failed

## Frontend Usage

The Dashboard component includes an "Export PDF" button that:

1. Calls the export endpoint with user ID and default options
2. Shows a loading state ("Exporting...")
3. Automatically downloads the PDF with the filename from the server
4. Displays error messages if the export fails

## Implementation Details

### Backend

**Library:** QuestPDF 2024.12.3
- Server-side PDF generation
- Layout engine with automatic pagination
- Font support and styling

**Service:** `PdfExportService`
- Implements `IPdfExportService` interface
- Generates PDF from `GeneratedReport` model
- Creates formatted filename with company, period, variant, and date

**Controller:** `ReportingController`
- Validates period existence
- Generates report data
- Calls PDF service
- Returns file with proper Content-Disposition header

### Frontend

**API Function:** `exportReportPdf`
- Uses `buildUrl` helper for consistent URL construction
- Extracts filename from Content-Disposition header
- Handles blob download automatically

**Dashboard Component:**
- Export PDF button next to Preview Report
- Loading state during export
- Error handling with user feedback

## Testing

### Unit Tests

Four comprehensive tests validate:

1. **PDF Generation**: Valid report generates valid PDF with correct header
2. **Options Support**: Title page and TOC are included when enabled
3. **Filename Generation**: Correct format with company, period, and date
4. **Variant Support**: Variant name included in filename when provided

All tests pass successfully.

## Security

- No vulnerabilities found in QuestPDF dependency
- Proper input validation on required fields
- Period existence validation before processing
- Error handling prevents information disclosure

## Filename Format

Format: `{Company}_{Period}_{Variant}_{Date}.pdf`

Examples:
- `Acme_Corp_2024_Annual_Report_2026-01-30.pdf`
- `Acme_Corp_Q1_2024_Management_2026-01-30.pdf`

Special characters in company/period names are replaced with underscores.

## Browser Compatibility

The PDF export works in all modern browsers that support:
- Fetch API
- Blob API
- Content-Disposition header parsing
- Automatic file downloads

## Future Enhancements

Potential improvements:

1. **Custom Branding**: Company logo on title page
2. **Advanced Formatting**: Custom colors, fonts, and styles
3. **Embedded Charts**: Visual data representations
4. **Bookmarks**: PDF bookmarks for each section
5. **Metadata**: PDF metadata tags for accessibility
6. **Multi-language**: Support for different languages
7. **Page Breaks**: Custom page break control
8. **Headers**: Section names in page headers
